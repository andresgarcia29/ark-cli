name: Release

on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      bump:
        description: 'Version bump type (major, minor, patch)'
        required: false
        default: 'patch'
        type: choice
        options:
          - major
          - minor
          - patch

permissions:
  contents: write
  packages: write

jobs:
  test:
    name: Test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run tests
        uses: ./.github/actions/go-test
        with:
          go-version: '1.25.5'

  create-tag:
    name: Create Version Tag
    runs-on: ubuntu-latest
    needs: [test]
    outputs:
      new-tag: ${{ steps.semver.outputs.new-tag }}
      previous-tag: ${{ steps.semver.outputs.previous-tag }}
      bump: ${{ steps.semver.outputs.bump }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GH_TOKEN }}

      - name: Create semantic version tag
        id: semver
        uses: ./.github/actions/semver-tag
        with:
          github-token: ${{ secrets.GH_TOKEN }}
          default-bump: ${{ inputs.bump || 'patch' }}
          tag-prefix: 'v'

  release:
    name: Build and Release
    runs-on: ubuntu-latest
    needs: [create-tag]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Fetch new tag
        run: git fetch --force --tags

      - name: Build and release
        uses: ./.github/actions/goreleaser-build
        with:
          github-token: ${{ secrets.GH_TOKEN }}

      - name: Summary
        run: |
          echo "## Release Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **New Version**: ${{ needs.create-tag.outputs.new-tag }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Previous Version**: ${{ needs.create-tag.outputs.previous-tag }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Bump Type**: ${{ needs.create-tag.outputs.bump }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸŽ‰ Release completed successfully!" >> $GITHUB_STEP_SUMMARY

      - name: Send iPhone notification
        if: always()
        run: |
          curl -s \
            -F "token=${{ secrets.PUSHOVER_TOKEN }}" \
            -F "user=${{ secrets.PUSHOVER_USER }}" \
            -F "title=GitHub Action Completed" \
            -F "message=Workflow ${{ github.workflow }} (${{
              github.run_number
            }}) finished with status: ${{ job.status }}" \
            https://api.pushover.net/1/messages.json
